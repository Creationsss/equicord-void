# Template file for 'obs-ws'
# Based on void-packages obs template with websocket support enabled
pkgname=obs-ws
version=32.0.4
revision=1
_ws_commit=1c9306b1e200704ebe192e06c893dfc06b097c43
archs="x86_64"
build_wrksrc=obs-studio-${version}
build_style=cmake
patch_args="-Np1 -d ${build_wrksrc}"
configure_args="-DOBS_VERSION_OVERRIDE=${version} -DENABLE_JACK=ON
 -DCMAKE_INSTALL_DATAROOTDIR=share -DENABLE_RNNOISE=OFF
 -DENABLE_VST=OFF -DENABLE_AJA=OFF
 -DENABLE_SCRIPTING_LUA=ON
 -DENABLE_NVENC=ON
 -DENABLE_QSV11=ON
 -DENABLE_WEBSOCKET=ON
 -DCMAKE_COMPILE_WARNING_AS_ERROR=OFF"
hostmakedepends="pkg-config swig python3-devel qt6-base"
makedepends="LuaJIT-devel fdk-aac-devel
 ffmpeg6-devel glu-devel jack-devel libXcomposite-devel libcurl-devel
 libva-devel pulseaudio-devel python3-devel speexdsp-devel
 v4l-utils-devel vlc-devel qt6-svg-devel x264-devel mbedtls-devel
 jansson-devel wayland-devel pipewire-devel libxkbcommon-devel
 pciutils-devel librist-devel srt-devel libdatachannel-devel
 libvpl-devel uthash qt6-base-private-devel json-c++ extra-cmake-modules
 simde nv-codec-headers websocketpp asio qrcodegen"
depends="xset xdg-desktop-portal"
short_desc="Open Broadcaster Software - with WebSocket support"
maintainer="creations <creations@creations.works>"
license="GPL-2.0-or-later"
homepage="https://obsproject.com"
distfiles="https://github.com/obsproject/obs-studio/archive/refs/tags/${version}.tar.gz
 https://github.com/obsproject/obs-websocket/archive/${_ws_commit}.tar.gz>obs-websocket-${_ws_commit}.tar.gz"
checksum="625ee6a29c3cf93177436094b8a16254c3eb21162356662b9a62c122aabd0a4b
 c09a8df4238010b69eb677ef482394322ae360898a7574063cace885f9622c18"
provides="obs-${version}_${revision}"
conflicts="obs>=0"

post_extract() {
	rm -rf ${build_wrksrc}/plugins/obs-websocket
	mv obs-websocket-${_ws_commit} ${build_wrksrc}/plugins/obs-websocket
}

pre_configure() {
	# disable browser plugin (sources not in tarball)
	touch plugins/obs-browser/CMakeLists.txt
}

obs-ws-devel_package() {
	short_desc+=" - development files"
	depends="${sourcepkg}>=${version}_${revision}"
	provides="obs-devel-${version}_${revision}"
	conflicts="obs-devel>=0"
	pkg_install() {
		vmove usr/lib/libobs-frontend-api.so
		vmove usr/lib/libobs-opengl.so
		vmove usr/lib/libobs.so
		vmove usr/lib/libobs-scripting.so
		vmove usr/include
		vmove usr/lib/cmake
		vmove usr/lib/pkgconfig
	}
}
